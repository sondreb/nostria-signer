<div class="container">
  @if (hasKeys()) {
  <div class="card">
    <h1 class="text-center">Nostria Signer</h1>

    <div class="tabs">
      <button class="tab" [class.active]="activeTab() === 'clients'" (click)="setActiveTab('clients')">
        Client Identities
      </button>
      <button class="tab" [class.active]="activeTab() === 'signer'" (click)="setActiveTab('signer')">
        Signer Identity
      </button>
      <button class="tab" [class.active]="activeTab() === 'relays'" (click)="setActiveTab('relays')">
        Relays
      </button>
    </div>

    @if (activeTab() === 'clients') {
    @for (key of keys(); track key.publicKey) {
    <div class="key-card">
      <div class="mb-3">
        <h3>Nostr Public Key:</h3>
        <div class="copy-container">
          <span class="copy-text">{{ getDisplayPublicKey(key.publicKey) }}</span>
          <button class="format-button" (click)="togglePubkeyFormat(key.publicKey)">
            {{ isHexFormatActive(key.publicKey) ? 'Show npub' : 'Show hex' }}
          </button>
          <button class="copy-button" (click)="copyToClipboard(key.publicKey)">Copy</button>
        
        </div>
      </div>

      <div class="mb-3">
        <h3>Nostr Private Key:</h3>
        <div class="copy-container">
          @if (isPrivateKeyVisible(key.publicKey)) {
          <span class="copy-text">{{ key.privateKey }}</span>
          } @else {
          <span class="copy-text masked-key">••••••••••••••••••••••••••••••••••••••••••••••••••••••••</span>
          }
          <button class="reveal-button" (click)="togglePrivateKeyVisibility(key.publicKey)">
            {{ isPrivateKeyVisible(key.publicKey) ? 'Hide' : 'Reveal' }}
          </button>
          <button class="copy-button" (click)="copyToClipboard(key.privateKey)">Copy</button>
        </div>
      </div>

      <!-- Activations Section -->
      <div class="mb-3">
        <h3>Activations</h3>
        @if (getActivationsForIdentity(key.publicKey).length > 0) {
        <div class="activations-list">
          @for (activation of getActivationsForIdentity(key.publicKey); track getActivationId(activation)) {
          <div class="activation-item">
            <div class="activation-details">
              <div><strong>Client:</strong>
                <span class="mono-text">{{ activation.clientPubkey === 'pending' ? 'Not yet connected' : activation.clientPubkey }}</span>
              </div>
              <div><strong>Activated:</strong> {{ formatDate(activation.activatedDate) }}</div>
              
              <!-- Show Connection URL only for pending activations -->
              @if (isPendingActivation(activation)) {
              <div class="mb-3">
                <strong>Connection URL:</strong>
                <div class="copy-container">
                  <span class="copy-text">{{ getConnectionUrl(activation) }}</span>
                  <button class="copy-button" (click)="copyToClipboard(getConnectionUrl(activation))">Copy</button>
                </div>
                <p class="connection-hint">Share this URL with your Nostr client to connect</p>
              </div>
              }
              
              <div class="permissions-container">
                <strong>Permissions:</strong>

                @if (isEditingPermissions(activation)) {
                <div class="permissions-edit">
                  <textarea 
                    [ngModel]="permissionsInput()[getActivationId(activation)]"
                    (ngModelChange)="updatePermissionsInput(activation, $event)"
                    class="permissions-input" 
                    placeholder="E.g., get_public_key,sign_event:0,nip44_encrypt"></textarea>
                  <div class="edit-actions">
                    <button class="save-button" (click)="savePermissions(activation)">Save</button>
                    <button class="cancel-button" (click)="cancelEditPermissions(activation)">Cancel</button>
                  </div>
                </div>
                } @else {
                <div class="permissions-display">
                  <span class="permissions-text">{{ formatPermissions(activation.permissions) }}</span>
                  <button class="edit-button" (click)="startEditingPermissions(activation)">Edit</button>
                </div>
                }
              </div>
            </div>
            <div class="activation-actions">
              <button class="delete-button" (click)="deleteActivation(activation)">Revoke</button>
            </div>
          </div>
          }
        </div>
        } @else {
        <p class="text-center">No activations for this identity.</p>
        }
        
        <!-- New activation button -->
        <div class="text-center mt-3">
          <button class="generate-activation-button" (click)="generateNewActivation(key.publicKey)">
            Generate New Activation
          </button>
        </div>
      </div>

      <div class="text-right">
        <button class="danger" (click)="deleteKey(key.publicKey)">Delete</button>
      </div>
      <hr class="key-divider">
    </div>
    }
    }

    @if (activeTab() === 'signer') {
    @if (account()) {
    <div class="key-card">
      <div class="mb-3">
        <h3>Signer Public Key:</h3>
        <div class="copy-container">
          <!-- <span class="copy-text">{{ account()?.publicKey }}</span> -->
          
          <span class="copy-text">{{ getDisplayPublicKey(account()!.publicKey) }}</span>
          <button class="format-button" (click)="togglePubkeyFormat(account()!.publicKey)">
            {{ isHexFormatActive(account()!.publicKey) ? 'Show npub' : 'Show hex' }}
          </button>


          <button class="copy-button" (click)="copyToClipboard(account()?.publicKey || '')">Copy</button>
        </div>
      </div>

      <div class="mb-3">
        <h3>Signer Private Key:</h3>
        <div class="copy-container">
          @if (isPrivateKeyVisible('signer')) {
          <span class="copy-text">{{ account()?.privateKey }}</span>
          } @else {
          <span class="copy-text masked-key">••••••••••••••••••••••••••••••••••••••••••••••••••••••••</span>
          }
          <button class="reveal-button" (click)="togglePrivateKeyVisibility('signer')">
            {{ isPrivateKeyVisible('signer') ? 'Hide' : 'Reveal' }}
          </button>
          <button class="copy-button" (click)="copyToClipboard(account()?.privateKey || '')">Copy</button>
        </div>
      </div>

      <div class="mb-3">
        <p class="signer-info">
          This is your signer identity that will be used to identity the remote signer.
        </p>
      </div>
    </div>
    } @else {
    <div class="key-card text-center">
      <p>No signer identity available. Generate a client identity first.</p>
    </div>
    }
    }

    @if (activeTab() === 'relays') {
    <div class="key-card">
      <h3>Manage Relays</h3>
      <p>Add or remove relays to connect your signer to the Nostr network</p>

      <div class="relay-list">
        @for (relay of relays(); track relay) {
        <div class="relay-item">
          <span>{{ relay }}</span>
          <button class="remove-button" (click)="removeRelay(relay)">Remove</button>
        </div>
        }

        @if (relays().length === 0) {
        <p class="text-center">No relays configured. Add at least one relay below.</p>
        }
      </div>

      <div class="add-relay-form">
        <input type="text" placeholder="wss://relay.example.com" [ngModel]="newRelay()"
          (ngModelChange)="newRelay.set($event)" class="relay-input" />
        <button class="add-button" [disabled]="!isValidUrl(newRelay())" (click)="addRelay()">Add Relay</button>
      </div>

      <div class="relay-info">
        <p>
          <strong>Note:</strong> Relays should start with "wss://" for secure WebSocket connections.
          Changes to relays will affect all your connections.
        </p>
      </div>
    </div>
    }

    @if (activeTab() === 'clients') {
    <div class="instructions">
      <h3>How to connect:</h3>
      <ol>
        <li>Look for the "Connection URL" in any pending activation</li>
        <li>Copy this URL to your Nostr client that supports NIP-46</li>
        <li>Look for "Connect with external signer" or similar option in your client</li>
        <li>Paste the URL and approve the connection</li>
      </ol>
    </div>
    }

    <div class="actions mt-4">
      <button class="primary" (click)="generateNewKey()">Generate New Client Identity</button>
      <button class="secondary" (click)="toggleImportModal()">Import Client Identity</button>
      <button class="secondary" (click)="resetAllKeys()">Reset All Keys</button>
    </div>
  </div>
  } @else {
  <div class="card text-center">
    <p>No keys available. Generating...</p>
    <button class="primary" (click)="generateNewKey()">Generate New Client Identity</button>&nbsp;
    <button class="secondary mt-2" (click)="toggleImportModal()">Import Client Identity</button>
  </div>
  }

  <!-- Import Modal -->
  @if (showImportModal()) {
  <div class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Import Client Identity</h2>
        <button class="close-button" (click)="toggleImportModal()">×</button>
      </div>
      <div class="modal-body">
        <p>Enter your private key in nsec or hex format:</p>
        <input 
          type="text" 
          [ngModel]="importKeyValue()" 
          (ngModelChange)="importKeyValue.set($event)" 
          class="import-input" 
          placeholder="nsec1... or hex private key" />
        
        @if (importError()) {
        <div class="error-message">{{ importError() }}</div>
        }
        
        @if (importSuccess()) {
        <div class="success-message">Successfully imported! Redirecting...</div>
        }
      </div>
      <div class="modal-footer">
        <button class="secondary-btn" (click)="toggleImportModal()">Cancel</button>
        <button class="primary-btn" (click)="importKey()" [disabled]="!importKeyValue()">Import</button>
      </div>
    </div>
  </div>
  }

  <!-- Add this at the end of the file, right before the closing </div> -->
  <app-theme-switcher></app-theme-switcher>
</div>